<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>home</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;

        background-color: rgba(181, 221, 186, 0);
      }

      nav {
        height: 0 px;
        background-color: #006769;
        display: grid;
        grid-template-columns: auto auto;
        height: 68px;
        z-index: 1010;

        padding-inline: 20px;
        justify-content: space-between;
        align-items: center;
        box-shadow: 1px 1px 1px rgba(24, 27, 29, 0.144);
      }
      
      nav a {
        text-decoration: none;
        color: #fffae6f1;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 15px;
        transition: 0.7s ease;
        padding-inline: 10px;
        border-radius: 15px;
        box-shadow: 1px 1px 1px rgba(24, 27, 29, 0.144);

        /* color: white; */
      }
      a:hover {
        text-decoration: none;
        color: rgb(153, 153, 226);
        font-size: 1.3;
      }
      .nav-menu {
        width: 100%;
      }
      .hamburger {
        display: none;
        cursor: pointer;
      }
      nav span {
        padding: 10px;
      }
      .bar {
        display: block;
        width: 25px;
        height: 3px;
        margin: 5px;
        -webkit-transition: all 0.3s ease-in-out;
        transition: all 0.3s ease-in-out;
        background-color: black;
      }
      .first {
        display: flex;
        justify-content: space-around;
        margin: 40px 0;
        align-items: center;
        padding-inline: 90px;
      }
      .first h1 {
        font-size: xxx-large;
      }
      .leftSection {
        width: 600px;
      }
      .cards {
        height: 110px;
        width: 110px;
        padding: 10px;
        border: 2px solid black;
      }
      .secand a {
        height: 130px;
        border-radius: 5px;
        padding: 0;
        text-decoration: none;
        color: #333333;
        background-color: #e1f2cd;
        box-shadow: 1px 1px 1px rgba(24, 27, 29, 0.144);
      }
      .secand p {
        text-align: center;
        padding-top: 9px;
        margin: 0;
      }
      .secand {
        display: flex;
        height: 300px;
        justify-content: space-between;
        align-items: center;
        padding-inline: 10%;
      }
      .secand div {
        background-color: #e1f2cd;
      }
      footer {
        background-color: #40A578;
        height: 400px;
        padding-inline: 8%;
        padding-top: 10px;
        align-items: center;
        justify-content: space-around;
      }
      .footer {
        padding-top: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .footerdiv {
        width: 302px;
        height: 300px;
        box-shadow: 1px 1px 1px rgba(24, 27, 29, 0.144);
        background-color: #fff;
        border-radius: 15px;
      }
      input {
        border-radius: 3px;
        border: 1px solid rgba(0, 0, 0, 0.774);
        box-shadow: 1px 1px 1px rgba(24, 27, 29, 0.144);
        padding: 3px;
        width: 35%;
      }
      button {
        background-color: #e1f2cd;
        border-radius: 4px;
        padding: 3px;
      }
      .templediv {
        display: grid;
        grid-template-columns: 30% 30% 30%;
        

        justify-content: space-between;
        align-items: center;
        padding-inline: 10%;
      }
      .tempesp {
        padding: 15px;
        text-align: center;
        padding-top: 9px;
        margin: 0;
        
        box-shadow: 1px 1px 1px rgba(24, 27, 29, 0.144);
        border-radius: 10px;
        background-color: #e1f2cd;
        margin-bottom: 15px;
      }
      .map {
        width: 100%;
        height: 400px;
      }
      .temple-image {
         width: 100px; 
         height: 100px; 
         margin: 5px; 
    
        }
        .eventDescription{
        height: 90px; 
         overflow:hidden;
        }
    </style>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <nav>
      <div class="left">
        <a href="http://localhost:3000/">
          <span><i class="fa-solid fa-hands-praying" height="50px"></i> <b>Devine connect</b></span></i></a>
        
        
        <span></span>
        <span></span>
      </div>
      <div class="right">
        <span><a href="login.html" id="login-logout" >Login</a></span>
       
       
        <a href="profile.html"><span id="user-container"></span></a>
      </div>
    </nav>

    <main>
      <section class="first">
        <div class="leftSection i">
          <h1><b>Book online pooja services for your spiritual needs</b></h1>
          <!-- <p style="color: #030303;">Find temples nearby or donate to support</p> -->
        
          
        </div>
        <div class="rightSection">
          <img src="./media/Image.png" alt="" />
         
        </div>
      </section>
      <section class="temples-section" style="height: fit-content">
        <div class="temples-container"></div>
        <div
          id="availableSlots"
          style="text-align: center; padding: 20px; font-size: 20px"
        ></div>
        <div id="bookingsList"></div>
      </section>
      <h2 style="text-align: center"><b>Explore spiritual needs</b></h2>
      <section class="secand">
        <a href="#"
          ><p><b>temple</b></p>
          <img src="./media/Image (4).png" width="100" alt=""
        /></a>
        <a href="#"
          ><p><b>Donations</b></p>
          <img src="./media/Image (5).png" width="100" alt=""
        /></a>
        <a href="#"
          ><p><b>Events</b></p>
          <img src="./media/Image (6).png" width="100" alt=""
        /></a>
        <a href="#"
          ><p><b>Services</b></p>
          <img src="./media/Image (7).png" width="100" alt=""
        /></a>
        <a href="#"
          ><p><b>History</b></p>
          <img src="./media/Image (8).png" width="100" alt=""
        /></a>

      
        <a href="#"
          ><p><b>Gallery</b></p>
          <img src="./media/Image (9).png" width="100" alt=""
            
        /></a>
      </section>
      <section>
        <h3>Find Nearby Temples</h3>
        <div class="map" id="map"></div>
        <p id="distanceInfo"></p>
        <button onclick="locateNearestTemple()">Locate Nearest Temple</button>
        <button onclick="locateAllTemples()">Locate All Temples</button>
        <!-- <h3 id="templeList"></h3> -->
        <h3 id="templeList" style="height: auto; overflow-y: auto; "></h3>
      </section>
      
    </main>
    <footer>
      <h2 style="text-align: center">Explore Temples news</h2>
      <div class="footer">
        <div class="footerdiv">
          <img src="./media/Image (3).png" height="120" alt="" />
          <div style="padding-inline: 20px">
            <h3>5 tips for Temple Donations</h3>
            <p>
              Lorem ipsum dolor sit. Lorem ipsum dolor sit amet consectetur
              adipisicing elit. Assumenda, minus aspernatur? Cumque.
            </p>
            <span><img src="./media/Image (10).png" alt="" height="25" /></span>
            <span>Dr.Temple</span>
          </div>
        </div>
        <div class="footerdiv">
          <img src="./media/Image (11).png" height="120" alt="" />
          <div style="padding-inline: 20px">
            <h3>5 tips for Temple Donations</h3>
            <p>
              Lorem ipsum dolor sit. Lorem ipsum dolor sit amet consectetur
              adipisicing elit. Assumenda, minus aspernatur? Cumque.
            </p>
            <span><img src="./media/Image (10).png" alt="" height="25" /></span>
            <span>Dr.Temple</span>
          </div>
        </div>
        <div class="footerdiv">
          <img src="./media/Image (12).png" height="120" alt="" />
          <div style="padding-inline: 20px">
            <h3>5 tips for Temple Donations</h3>
            <p>
              Lorem ipsum dolor sit. Lorem ipsum dolor sit amet consectetur
              adipisicing elit. Assumenda, minus aspernatur? Cumque.
            </p>
            <span><img src="./media/Image (10).png" alt="" height="25" /></span>
            <span>Dr.Temple</span>
          </div>
        </div>
      </div>
    </footer>

    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const token = getCookie("token");
          console.log("FRONT END TOKEN" + token); // Use a function to get cookie value

          if (!token) {
            // If token is not present, redirect to login page
            window.location.href = "/login.html";
            return;
          }
          console.log("token   =" + token);
          const response = await fetch("/profile", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const user = await response.json();
            console.log("user =",user);
            displayUser(user);
            var loginLogoutLink = document.getElementById("login-logout");
             loginLogoutLink.innerText = "Logout";
             loginLogoutLink.addEventListener("click", toggleLoginLogout);
          } else if (response.status === 401) {
            // If unauthorized, redirect to login page
            window.location.href = "/login.html";
          } else {
            const errorData = await response.json();
            alert(errorData.error || "Failed to fetch user profile");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to fetch user profile");
        }
      });

      function displayUser(user) {
        const userContainer = document.getElementById("user-container");
        userContainer.innerHTML = `<i class="fa-solid fa-user"></i> ${user.username}`;
      }
      function toggleLoginLogout() {
      
        var loginLogoutLink = document.getElementById("login-logout");

    // Check if the link currently says "Logout"
   
    if (loginLogoutLink.innerText === "LOGOUT") {
        // Clear cookie named "token"
        document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        
        // Clear token from local storage (if any)
        localStorage.removeItem("token");
       
        // Redirect to the login page
         window.location.href = "/login.html";
    } else {
        // If user is not logged in, redirect to the login page
         window.location.href = "/login.html";
    }
        // If user is logging out, remove token from local storage

        loginLogoutLink.innerText = "logout";
        // loginLogoutLink.href = "login.html"; // Change href if needed
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const token = getCookie("token");
          if (!token) {
            // If token is not present, redirect to login page
            window.location.href = "/login.html";
            return;
          }

          const response = await fetch("/temples", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const temples = await response.json();
            console.log("TEMPLES FORM BACKEND ",temples)
            // Load the Google Maps API dynamically
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAhRAzbk-xkSfWvrJ1FfBRkqp9GIb-NMOg&libraries=geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            // Define initMap function
            window.initMap = function () {
              // Call initMap with temples as an argument
              initMapWithData(temples);
            };
            displayTemples(temples);
          } else if (response.status === 401) {
            // If unauthorized, redirect to login page
            window.location.href = "/login.html";
          } else {
            const errorData = await response.json();
            alert(errorData.error || "Failed to fetch temples");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to fetch temples");
        }
      });

      function displayTemples(temples) {
        console.log("temples",temples[0]._id);
        const templesContainer = document.querySelector(".temples-container");

        temples.forEach((temple) => {
          const templeCard = document.createElement("div");
          templeCard.classList.add("temple-card");

          // Add temple name
          const nameElement = document.createElement("h3");
          nameElement.textContent = temple.name;
          templeCard.appendChild(nameElement);

          // Add temple images
          
            const imageElement = document.createElement("img");
            const imageUrl = `/uploads/${temple._id}/${temple.images[0]}`;
            imageElement.src = imageUrl;
            imageElement.classList.add("temple-image");
            templeCard.appendChild(imageElement);
        



          // Add temple about
          const aboutElement = document.createElement("p");
          aboutElement.textContent = temple.about;
          templeCard.appendChild(aboutElement);

          let scrollAmount = 1; // Adjust this value to change the scroll speed
          const element=aboutElement;
          element.classList.add("eventDescription");
  function startScrolling() {
    element.scrollTop += scrollAmount;

    // If the scrollTop has reached the end, reset to start
    if (element.scrollTop + element.clientHeight >= element.scrollHeight) {
      element.scrollTop = 0;
    }
    setTimeout(startScrolling, 50); // Adjust the second argument to change speed
  }

  startScrolling();

          templeCard.addEventListener("click", async () => {
            localStorage.setItem("selectedTempleId", temple._id);
            window.location.href = "templeDetails.html";
            
          });

          templeCard.classList.add("tempesp");
          templesContainer.appendChild(templeCard);
          templesContainer.classList.add("templediv");
        });
      }

      function showDirectionsToTemple(templeLat, templeLng) {
        console.log("from show directions to temple");
        console.log("coordinares= ", templeLat, templeLng);
        if (userLocation && templeLat && templeLng) {
          var destination = { lat: templeLat, lng: templeLng };
          calculateAndDisplayRoute(userLocation, destination);
        }
      }
      var userLocation = null; // Declare userLocation variable
      var map;
      var markers = [];
      console.log("form map markkers");
      function initMapWithData(temples) {
        console.log("hdfdfd form init map", temples);
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 10,
        });
       
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            map.setCenter(userLocation);

            // Add marker for user's location
            var userMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "User",
            });
          });
        } else {
          // Default to a location if geolocation is not supported
          var defaultLocation = { lat: 37.7749, lng: -122.4194 }; // San Francisco
          map.setCenter(defaultLocation);
        }

        // Add markers for nearby temples
        templescor = temples;
        var temples = [];

        templescor.forEach((temp) => {
          addTemple(
            temp.name,
            temp.location.coordinates[1],
            temp.location.coordinates[0]
          );
        });
       
        function addTemple(name, lat, lng) {
          temples.push({
            name: name,
            location: {
              lat: lat,
              lng: lng,
            },
          });
        }
        temples.forEach(function (temple) {
          var marker = new google.maps.Marker({
            position: temple.location,
            map: map,
            title: temple.name,
          });
          markers.push(marker); // Add marker to the markers array

          // Add click listener to display route to the temple
          marker.addListener("click", function () {
            calculateAndDisplayRoute(userLocation, temple.location);
          });
        });

        // Call locateAllTemples after the map is initialized
        locateAllTemples();
      }

      function locateAllTemples() {
        // Locate all temples on the map
        var bounds = new google.maps.LatLngBounds();
        markers.forEach(function (marker) {
          bounds.extend(marker.getPosition());
        });
        map.fitBounds(bounds);

        // Display the list of temples
        var templeList = "All Temples:<br>";
        markers.forEach(function (marker) {
          templeList +=
            marker.title +
            " (Distance: " +
            calculateDistance(userLocation, marker.position).toFixed(2) +
            " meters)<br>";
        });
        document.getElementById("templeList").innerHTML = templeList;
      }

      // Your other functions remain unchanged

      function findNearestTemple(userLocation) {
        // Find the nearest temple to the user's location
        var nearestTemple = null;
        var nearestDistance = Infinity;
        markers.forEach(function (marker) {
          var distance = google.maps.geometry.spherical.computeDistanceBetween(
            new google.maps.LatLng(userLocation.lat, userLocation.lng),
            marker.getPosition()
          );
          if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestTemple = marker;
          }
        });
        return nearestTemple;
      }

      function calculateAndDisplayRoute(origin, destination) {
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          panel: document.getElementById("templeList"),
        });

        directionsService.route(
          {
            origin: origin,
            destination: destination,
            travelMode: "DRIVING",
          },
          function (response, status) {
            if (status === "OK") {
              directionsRenderer.setDirections(response);

              // Calculate distance in kilometers
              var distanceInMeters =
                google.maps.geometry.spherical.computeDistanceBetween(
                  origin,
                  destination
                );
              var distanceInKilometers = distanceInMeters / 1000; // Convert meters to kilometers

              // Add a marker with distance information
              var distanceParagraph = document.getElementById("distanceInfo");
              distanceParagraph.innerText =
                "Distance: " + distanceInKilometers.toFixed(2) + " km";
              var distanceMarker = new google.maps.Marker({
                position: destination,
                map: map,
                label: distanceInKilometers.toFixed(2) + " km",
                fontWeight: "bold", // Increase font weight
                color: "#000000",
                fontSize: "46px",
              });
            } else {
              window.alert("Directions request failed due to " + status);
            }
          }
        );
      }

      function calculateDistance(origin, destination) {
        return google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(origin.lat, origin.lng),
          new google.maps.LatLng(destination.lat(), destination.lng())
        );
      }
      function locateNearestTemple() {
        // Locate the nearest temple to the user's location
        if (userLocation) {
          var nearestTemple = findNearestTemple(userLocation);
          if (nearestTemple) {
            map.setCenter(nearestTemple.location);
            map.setZoom(15); // Zoom in to show the nearest temple more clearly
            document.getElementById("templeList").innerText =
              "Nearest Temple: " +
              nearestTemple.title +
              " (Distance: " +
              calculateDistance(userLocation, nearestTemple.position).toFixed(
                2
              ) +
              " meters)";
            calculateAndDisplayRoute(userLocation, nearestTemple.position); // Display route to the nearest temple
          }
        }
      }
    </script>

  
    <script src="./js/nav.js"></script>
    <script src="./js/index.js"></script>
  </body>
</html>
